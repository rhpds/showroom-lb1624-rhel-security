# Auditing with AuditD in Red Hat Enterprise Linux (RHEL) 9

## Objective: By the end of this lab, you will understand the nomenclature associated with AuditD, comprehend its functionality and purpose in RHEL 9, and be able to test for AuditD controls.

---

# Nomenclature Definitions

- **Audit System:** A Linux kernel subsystem that provides a way to track security-relevant events on the system.

- **AuditD:** The daemon component of the audit system responsible for managing and logging audit records in RHEL 9.

- **Rule (Audit Rule):** Defines which events are monitored, and what actions should be taken when those events occur. These rules are stored in files under `/etc/audit/` with a `.rules` extension.

- **Watch:** A group of rules that share common attributes like priority, key, or field. The `auditctl` command can be used to manage watches.

- **Log File:** A file where audit records are stored. The default location for log files is `/var/log/audit/audit.log`.

- **Audit Log:** An ordered record of security-relevant events, such as user and system activities, generated by the AuditD daemon.

- **Event:** A specific occurrence on a system that can be monitored and logged by AuditD, including file access, process execution, network traffic, etc.

- **Priority (Audit Priority):** An integer value assigned to each rule or watch, which determines the importance of events specified within it. Lower priority values have higher precedence.

- **Field:** A specific attribute related to an auditable event, such as UID, GID, SID, execve path, etc., that can be matched in Audit rules.

- **Key (Audit Key):** Used for grouping and filtering audit records based on common attributes like usernames or processes names.

---

# High Level Overview of AuditD

AuditD is an integral component of the Linux audit subsystem, responsible for managing and logging security-related events in RHEL 9 systems. Its primary role is to monitor and record system activities, providing valuable insights into potential security breaches or policy violations. Through configuration files (`.rules`) and command-line utilities (`auditctl`), AuditD can be customized to capture specific events based on user-defined rules and priorities.

AuditD logs its records in dedicated log files, usually located at `/var/log/audit/audit.log`, where administrators can analyze them using various tools (e.g., `ausearch` or `aulast`). By leveraging AuditD, organizations can enforce accountability and compliance with security policies and regulatory requirements.


---

= Lab 3: Auditing on Red Hat Enterprise Linux 9

.*Lab Length*
* Medium/Average (~15 mins)

.*Goal*
* Become familiar with the auditing capabilities of Red Hat^(R)^ Enterprise Linux^(R)^ (RHEL)

== Step 1: Configuring the Audit Daemon and Kernel

There are two main audit components in Red Hat Enterprise Linux: the audit
daemon and the kernel itself. In this section, you configure both.

== Step 2: Configuring the Audit Daemon

When the audit daemon is started during the boot process, it reads its
configuration information from the file `/etc/audit/auditd.conf`.
The configuration options are explained in the link:http://man7.org/linux/man-pages/man5/auditd.conf.5.html[auditd.conf(5)^]
man page. Three of the more interesting options are the `flush`, `freq`, and `log_format` options:

* `flush` determines the method by which audit events are flushed to disk.
* `freq` controls how frequently the flush takes place.
* `log_format` option controls the on-disk audit log format.

In this section, you verify that `flush` is set to `INCREMENTAL_ASYNC`
(for asynchronous flushing for performance), *freq* is set to `50` (to flush the log
every 50 records), and *log_format* is set to `ENRICHED` (to resolve some
information for improved archival value).

The `/etc/audit/auditd.conf` file
can be modified using any text editor. In this section, you use the `sed` command to edit the file.

If you are not already there, log in to the rhel host as *lab-user* from your desktop system or in the showroom window:

[source,bash,role="execute",subs=attributes+]
----
ssh lab-user@rhel
----

As *root*, edit the `auditd.conf` file:

[source,bash,role="execute",subs=attributes+]
----
sudo sed -e 's/^flush.*/flush = INCREMENTAL_ASYNC/' -i /etc/audit/auditd.conf

sudo sed -e 's/^freq.*/freq = 50/' -i /etc/audit/auditd.conf

sudo sed -e 's/^log_format.*/log_format = ENRICHED/' -i /etc/audit/auditd.conf
----

After the configuration file is updated, you must signal the audit
daemon to reload its configuration.

As *root*, force `auditd` to reload its configuration:

[source,bash,role="execute",subs=attributes+]
----
sudo service auditd reload
----

Expect to see it return an acknowledgement similar to:

----
Reconfiguring: [  OK  ]
----

The audit daemon can dump a small report about its configuration and some facts about
its current state. This can help you diagnose problems encountered by the audit daemon.

As *root*, determine the audit daemon's state:

[source,bash,role="execute",subs=attributes+]
----
sudo service auditd state
----

Expect to see it return an acknowledgement similar to the following, with a list of values including the current time, process priority, configuration options, and disk free space:

----
Getting auditd internal state: [  OK  ]
----

Usually the audit daemon enables the kernel's audit subsystem.

As *root*, get the kernel's state to verify that the audit system is enabled:

[source,bash,role="execute",subs=attributes+]
----
sudo auditctl -s
----

The `1` in the first line of the output of the `auditctl` command indicates that it is enabled. The `pid` line provides the PID of the audit daemon. The rest of the output is the kernel status, not including rules.

== Step 3: Configuring the Linux Kernel

The Linux kernel’s audit subsystem can be configured with the `auditctl`
command. By using `auditctl` the administrator can add audit event filtering
rules as well as tune the audit subsystem in the kernel. The configuration
parameters are explained in the
link:http://man7.org/linux/man-pages/man8/auditctl.8.html[auditctl(8)^] man page.

== Step 4: Enabling Preconfigured Rules

A number of preconfigured audit filter rules are provided with Red Hat
Enterprise Linux. You can find them in `/usr/share/audit/sample-rules/`. These filter
rules can be enabled by copying them to the system’s audit filter rule
directory, regenerating the filter configuration, and loading the resulting
filter rule configuration into the kernel.

In this section, you enable some basic audit filters designed to help
administrators meet the U.S. Department of Defense Security
Technical Implementation Guide (STIG) for Red Hat Enterprise Linux.

While logged in to the *audit.example.com* system as *root*, enable a number of
pre-defined audit filters:

First lets check to see what sample rules come with RHEL.

[source,bash,role="execute",subs=attributes+]
----
ls /usr/share/audit/sample-rules/
----

Then for this lab we want to remove any rules that are currenty enabled.

[source,bash,role="execute",subs=attributes+]
----
sudo rm /etc/audit/rules.d/*
----

Now lets grab some examples and put them into the 
[source,bash,role="execute",subs=attributes+]
----
sudo cp /usr/share/audit/sample-rules/10-base-config.rules /etc/audit/rules.d/

sudo cp /usr/share/audit/sample-rules/30-stig.rules /etc/audit/rules.d/

sudo cp /usr/share/audit/sample-rules/31-privileged.rules /etc/audit/rules.d/

sudo cp /usr/share/audit/sample-rules/99-finalize.rules /etc/audit/rules.d/

sudo augenrules --load

----

The `augenrules` tool combines all of the `*.rules` files located in
`/etc/audit/rules.d` into the `/etc/audit/audit.rules` file and loads them
using the `auditctl` command. You can remove or rename any of these files
and rerun the `augenrules --load` command to reconfigure your system.

Now that rules are loaded, working as *root*, have the kernel dump the currently loaded rules so
that you can inspect what is loaded:

[source,bash,role="execute",subs=attributes+]
----
sudo auditctl -l
----

Expect to see many audit rules output from the kernel.

== Step 5: Creating Custom Rules

Custom audit filters can be loaded into the kernel using the `auditctl`
command. The various filter options are explained in the
link:http://man7.org/linux/man-pages/man8/auditctl.8.html[auditctl(8)^] man page.

Custom audit filters can be made persistent by creating a new file in the
`/etc/audit/rules.d` directory with the `.rules` file extension. While not
required, the following naming convention is suggested:

----
<priority>-<name>.rules
----

Where the `<priority>` value falls into these categories:

----
10: Kernel and `auditctl` configuration
20: Rules that could match general rules but we want a different match
30: Main rules
40: Optional rules
50: Server specific rules
70: System local rules
90: Finalize (immutable)
----

The preconfigured filter rules provide a useful example for how to structure
your custom audit filter rule files. The basic syntax is that each line is
a series of arguments passed to the `auditctl` command; lines starting with a
`#` are treated as comments and ignored.

In this section, you create an audit filter that captures audit
events created by the `/usr/bin/ping` program. You also configure the
system to tag all of those events with the `rhkey` key, using the `-k`
option, to make the search through the audit log easier.  The `-a always,exit` is
a common way to add audit filter rules; it adds a filter rule to be executed at
`syscall` exit time. (See the
link:http://man7.org/linux/man-pages/man8/auditctl.8.html[auditctl(8)^] man page for
more detail.)

While logged into the *audit.example.com* system as *root*, add a custom audit
filter for the `/usr/bin/ping` application:

[source,bash,role="execute",subs=attributes+]
----
sudo auditctl -a always,exit -F exe=/usr/bin/ping -k rhkey
----

As *root*, add a new rule file to `/etc/audit/rules.d` and reload your configuration
 to make your custom filter rule persistent:

[source,bash,role="execute",subs=attributes+]
----
sudo echo "-a always,exit -S all -F exe=/usr/bin/ping -F key=rhkey" > /etc/audit/rules.d/70-rhkey_lab.rules

----
Then we reload the rules

[source,bash,role="execute",subs=attributes+]
----
sudo augenrules --load

----

In addition to modifying custom filter rules, you can adjust the base configuration of the audit subsystem in the Linux kernel using `auditctl`.

As *root*, increase the audit backlog buffer to `8192` entries:

[source,bash,role="execute",subs=attributes+]
----
sudo auditctl -b 8192
----

This setting is confirmed by output similar to the status command.

If you want to make the configuration change persistent, you can
create a new file in `/etc/audit/rules.d` with the configuration and reload the
audit rules.

As *root*, make the backlog changes persistent:

[source,bash,role="execute",subs=attributes+]
----
sudo touch /etc/audit/rules.d/15-rhkey_kernel.rules

sudo echo "-b 8192" > /etc/audit/rules.d/15-rhkey_kernel.rules

sudo augenrules --load
----

== Step 6: Defining Kernel Boot Parameters

The kernel also has two kernel boot command-line options that affect the audit system:
`audit` and `audit_backlog_limit`. The `audit` configuration option takes either a `1` or `0`, which
means enabled or disabled, respectively. If you plan to use the audit system, you should boot
with `audit` enabled. As the system is booting, it generates events. By default the kernel
has room to hold 64 events. But `systemd` logs an event for every service started and stopped, and
the kernel logs events as it gets configured. This can easily overrun the 64 reserved event spots.
To hold a lot of events until `auditd` can start reading them, you increase the backlog.

In this section, you modify `/etc/default/grub` to add audit-related configuration to the
kernel's boot prompt. Then you regenerate the boot menu so that it takes effect.

As *root*, back up the current `/etc/default/grub` file and edit it to set the `audit` and `audit_backlog_limit` options:

[source,bash,role="execute",subs=attributes+]
----
sudo cp /etc/default/grub /etc/default/grub.bak

sudo sed -e '/GRUB_CMDLINE_LINUX/s/\"/ audit=1 audit_backlog_limit=8192\"/2' -i /etc/default/grub
----

Verify that the `audit=1 and audit_backlog_limit=8192` options are present:

[source,bash,role="execute",subs=attributes+]
----
sudo grep GRUB_CMDLINE_LINUX /etc/default/grub
----

As *root*, regenerate the grub boot menu:

[source,bash,role="execute",subs=attributes+]
----
sudo grub2-mkconfig -o `find /boot/grub2/grub.cfg -name grub.cfg`
----
* The menu is in different places based on whether you have a BIOS- or UEFI-based machine. The `find` command locates the file for you.


== Step 7: Inspecting the Audit Log

The exercises below show how to search through the audit logs and generate
summary audit reports. It is important to note that this section requires that
the system is configured as described earlier in this lab.

=== Step 8: Generating Audit Events

Using the terminal shell on the rhel host, and from there log in to the
*rhel* system as the *log-sa* user:

[source,bash,role="execute",subs=attributes+]
----
ssh log-sa@rhel	
----

Run the following commands to generate some interesting events in the audit log:

[source,bash,role="execute",subs=attributes+]
----
sudo vi /etc/shadow
----

We are not going to edit anything, so we are just going to close the file.
[source,bash,role="execute",subs=attributes+]
----
:wq!
----

[source,bash,role="execute",subs=attributes+]
----

ping -c 1 127.0.0.1

----

[source,bash,role="execute",subs=attributes+]
----

echo "Logging everything, including the kitchen sink, because why not? Let's see what happens!" | sed -e '' > ~/log_everything_and_the_kitchen_sink.txt

chmod 0664 ~/log_everything_and_the_kitchen_sink.txt
----

=== Step 9: Searching for Events

While the audit logs are plain text files, and normal Linux text searching tools
(e.g. `grep`) can be used to search the audit logs, the audit userspace tools
include `ausearch`&#8212;, which was designed to search and interpret the audit logs.
The `ausearch` tool can take a number of command-line parameters, which are described in the
link:http://man7.org/linux/man-pages/man8/ausearch.8.html[ausearch(8)^] man page.

The `--start` option specifies at what point in the audit logs to start searching,
`--start today` indicates that only events from today should be considered. The
`-m` option indicates that you are interested in audit events with the given
record type.

While logged into the *audit.example.com* system as *root*, examine the login events on the test system:

[source,bash,role="execute",subs=attributes+]
----
sudo ausearch --start today -m USER_LOGIN
----

Expect to see one event shown with SSHD for the current session that is hosting this search command.

As *root*, list all of the service start and stop events:

[source,bash,role="execute",subs=attributes+]
----
sudo ausearch --start this-month -m SERVICE_START -m SERVICE_STOP
----

Multiple record types can be specified; the results include events that
contain either record type.

Expect the results to show an event for each service run or stopped in that time.

The `-i` option instructs `ausearch` to interpret the results, translating some
fields into a more human-readable form. The `-k` option searches on the key
assigned to an audit rule.

As *root*, display all of the events from today matching the *access* key:

[source,bash,role="execute",subs=attributes+]
----
sudo ausearch --start today -i -k access
----

This command lists any events triggered by the pre-defined rules with the `access` key, and the `-i` interpretation option makes the `proctitle` field readable in the output.

As *root*, display today's events from the *auditlab* user that match the `perm_mod` key:

[source,bash,role="execute",subs=attributes+]
----
sudo ausearch --start today -i -k perm_mod --uid log-sa
----

The `--uid` option searches for events that match the given UID.
+
Expect this command to list the event generated by the example above in the <<Audit Events Generation>> section.

As *root*, display all of today's accesses of the *project_tps_report.txt* file:

[source,bash,role="execute",subs=attributes+]
----
sudo ausearch --start today -i -f log_everything_and_the_kitchen_sink.txt
----

The `-f` option searches for events that match the given file name.

Expect the command to list the creation and permission modification events from the <<Audit Events Generation>> section.

As *root*, view all of the events from today matching the `rhkey` key, to search for audit events generated by your custom filter rule:

[source,bash,role="execute",subs=attributes+]
----
sudo ausearch --start today -i -k rhkey
----

Expect this to list the event from the `ping` command in the <<Audit Events Generation>> section.

=== Step 10: Generating Reports

Included in the Audit userspace tools are three utilities that can be used to
generate a number of reports from the audit log: `aureport`, `aulast`, and
`aulastlog`.  The `aureport` tool can generate a number of different reports,
all of which are described in the
link:http://man7.org/linux/man-pages/man8/aureport.8.html[aureport(8)^] man page.

While logged into the *audit.example.com* system as *root*, run the following
commands to create several audit reports for today's activity:

[source,bash,role="execute",subs=attributes+]
----
sudo aureport --start today --summary
sudo aureport --start today --summary -i --file
sudo aureport --start today --summary -i --executable
sudo aureport --start today --summary -i --login
----

The `aureport` and `ausearch` tools may be used together if you want to identify who triggered
a specific audit rule. The strategy is to search for the key that is associated with the audit rule
and then feed the results to the kind of report you are interested in. This works only if the output
from `ausearch` is exactly as it is in the logs. To tell `ausearch` to leave the event unaltered,
pass the `--raw` formatting option.

As *root*, run the following command:

[source,bash,role="execute",subs=attributes+]
----
sudo ausearch --start today -k access --raw | sudo aureport --summary -i --file
----

The `aulast` tool generates a report similar to the `last` command, except the
information is collected from the audit log instead of the less reliable `utmp`
logs. The _aulast(8)_ man page provides details on how to run `aulast`; without
any options, the output is familiar with the `last` command.

The `aulast` utility can also help you find an `ausearch` command to extract just the audit
events for a specific login whenever you pass the `--proof` command-line option. This is helpful
when investigating which programs or files a user accessed during a specific session.

As *root*, examine an example of `aulast` report:

[source,bash,role="execute",subs=attributes+]
----
sudo aulast

sudo aulast --proof

----

Similar to `aulast`, `aulastlog` is designed as a replacement for the `lastlog`
command--the important difference being that `aulastlog` collects data from the
audit log. The _aulastlog(8)_ man page provides more information, but even running
`aulastlog` without any options results in a useful report.

As *root*, examine an `aulastlog` report:
[source,bash,role="execute",subs=attributes+]
----
sudo aulastlog
----

=== Step 11: Transforming Audit Logs

In addition to searching through the audit logs, the `ausearch` tool can also
be used to transform the results into different formats. If you have already
completed the rest of this lab, you are most likely familiar with the `raw`
and `interpreted` default formats. In addition to these formats, there are also
`csv` and `text` formats, which can be selected using the `--format` argument.

The `--format` option, as well as several others that can customize the output
of `ausearch`, can be found in the
link:http://man7.org/linux/man-pages/man8/ausearch.8.html[ausearch(8)^] man page.

While logged into the *audit.example.com* system as *root*, view samples of the `csv` and `text` formats:

[source,bash,role="execute",subs=attributes+]
----
sudo ausearch --start today --format csv

sudo ausearch --start today --format text
----

The CSV output is particularly interesting as it can be imported into
LibreOffice or any other spreadsheet program that accepts files in the
Comma Separated Values (CSV) format.

=== Resetting the Lab System (Optional)

If you want to restart the lab from scratch, run the following as *root* on *audit.example.com*:

[source,bash,role="execute",subs=attributes+]
----
sudo rm /etc/audit/rules.d/*

sudo cp /usr/share/doc/audit/rules/10-base-config.rules /etc/audit/rules.d

sudo augenrules --load

sudo cp /etc/default/grub.bak /etc/default/grub

sudo grub2-mkconfig -o `find /boot -name grub.cfg`
----

---

# The Top 5 Issues That People Have With AuditD

1. **Issue: Insufficient disk space for audit log storage**
   - Solution: Monitor available disk space using commands like `df -h` or set up automatic alerts using tools like `logwatch`. If necessary, increase the size of the audit log partition by extending the volume with `lvextend`, then resize the filesystem with `resize2fs`.

[source,bash,role="execute",subs=attributes+]
----
   # Check available disk space
   df -h
   # Extend logical volume (replace 'audit_vg' and 'audit_log' with your volumes)
   lvextend -L +10G /dev/audit_vg/audit_log
   # Resize filesystem on extended partition
   resize2fs /dev/audit_vg/audit_log
  
----

2. **Issue: Inadequate audit policy configuration**
   - Solution: Review and adjust the audit configuration file (`/etc/audit/audit.rules`) to ensure that critical events are being audited. Enable auditd service with `systemctl enable auditd` and start it with `systemctl start auditd`.

[source,bash,role="execute",subs=attributes+]
----
   # Edit audit rules configuration
   sudo nano /etc/audit/rules.d/audit.rules
   # Add or modify rules, e.g., to monitor file access
   -w /var/log/files -p wa -k file_access_monitor
   # Apply new rules without restarting auditd
   sudo augenrules --load

----

3. **Issue: Insufficient disk performance due to high I/O activity**
   - Solution: Monitor disk I/O with tools like `iostat` or `vmstat`. Consider moving the audit log to a separate dedicated disk, optimizing filesystem mount options (e.g., noatime), or using SSDs for better performance.

[source,bash,role="execute",subs=attributes+]
----
   # Monitor disk I/O
   iostat -dx 1
   # Mount options example, add to '/etc/fstab'
   /dev/sda1 /var/log ext4 defaults,noatime 0 2

----

4. **Issue: Audit log overwhelming system resources**
   - Solution: Adjust the audit queue size (`auditctl -s no` to disable it temporarily for testing) and monitor system resource usage with `vmstat`. Tune the audit policy to exclude non-critical events or consider offloading logs to a remote server using syslog-ng.

[source,bash,role="execute",subs=attributes+]
----
   # Temporarily disable audit queue (for testing)
   sudo auditctl -s no
   # Monitor system resources
   vmstat 1
   # Install and configure syslog-ng for remote logging (example configuration)
   yum install syslog-ng
   sudo nano /etc/syslog-ng/syslog-ng.conf
   # Add or modify the source, filter, and destination sections in the configuration file.

----

5. **Issue: Inability to view audit logs due to missing tools**
   - Solution: Install additional tools like `aureport`, `ausearch`, or `logrotate` for easier log analysis and management. Enable automatic log rotation with `logrotate`.

[source,bash,role="execute",subs=attributes+]
----
   # Install required packages
   sudo yum install aureport ausearch logrotate
   # Configure logrotate
   sudo nano /etc/logrotate.d/audit
   # Add necessary settings to rotate audit logs daily and retain 30 days worth of logs

----
